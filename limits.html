<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>CombineHarvester: Limits</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CombineHarvester
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('limits.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Limits </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#limits-one-POI">Limits in models with one POI</a><ul><li class="level2"><a href="#limits-creating-the-datacards">Creating the datacards</a></li>
<li class="level2"><a href="#limits-building-the-workspaces">Building the workspaces</a></li>
<li class="level2"><a href="#limits-calculating-limits">Calculating limits</a></li>
<li class="level2"><a href="#limits-collecting">Collect the output</a></li>
<li class="level2"><a href="#limits-plotting">Plotting</a></li>
<li class="level2"><a href="#limits-morphing-cards">Workflow with RooMorphingPdf datacards</a></li>
</ul>
</li>
<li class="level1"><a href="#limits-more-POIs">Limits in models with more than one POI</a><ul><li class="level2"><a href="#limits-pre-vs-post">Expected limits: pre-fit vs post-fit</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>In these examples we will work through several different limit calculations using datacards from the Run 1 HTT analyses.</p>
<h1><a class="anchor" id="limits-one-POI"></a>
Limits in models with one POI</h1>
<p>First we will compute limits vs mH in the legacy SM Higgs analysis (HIG-13-004). This task will be broken down into several steps:</p>
<ol type="1">
<li>Creating the datacards and shape files using CombineHarvester</li>
<li>Combining datacards per-channel and converting to binary workspaces</li>
<li>Running the asymptotic limit calculation for each signal mass point</li>
<li>Collecting the combine output into a common json format</li>
<li>Using these json files to create plots of the limits</li>
</ol>
<h2><a class="anchor" id="limits-creating-the-datacards"></a>
Creating the datacards</h2>
<p>Go to the <code>CombineTools</code> directory and create the datacards using the <code>SMLegacyExample.py</code> script: </p>
<pre class="fragment">cd $CMSSW_BASE/src/CombineHarvester/CombineTools
python scripts/SMLegacyExample.py
</pre><p>This will create a familiar structure of datacards in <code>output/sm_cards</code>, with one subdirectory containing the datacards for all channels and categories (<code>cmb</code>) and subdirectories containing just the cards for specific channels (e.g. <code>tt</code>). Within each of these directories the cards are organised into further subdirectories corresponding to the mass of the signal.</p>
<h2><a class="anchor" id="limits-building-the-workspaces"></a>
Building the workspaces</h2>
<p>We will focus on computing the limits for each channel separately, but before we get to this we need to turn the datacards into binary RooFit workspaces. This means combining the cards from each category into a single text datacard with <code>combineCards.py</code>, then running <code>text2workspace.py</code> to convert this single card into a workspace.</p>
<dl class="section note"><dt>Note</dt><dd>It is possible to run <code>combine</code> directly with a text datacard as input. Internally <code>combine</code> will just run <code>text2workspace.py</code> on it first with some default options and save the resulting workspace in a temporary location. For anything other than very simple models it is preferable to create the workspaces manually which can then be reused for later calculations.</dd></dl>
<p>The <code>combineTool.py</code> script has a mode called <b>T2W</b> that passes options through to <code>text2workspace.py</code> and supports multiple datacard or directory options. With a directory argument, all the cards within that directory are combined first. If the enclosing directory is a number then this will automatically be used as the <code>-m [mass]</code> option in <code>text2workspace.py</code>, so there is no need to specify this explicitly. We can also take advantage of the <code>--parallel</code> option to build multiple workspaces simultaneously. </p>
<pre class="fragment">cd output/sm_cards
combineTool.py -M T2W -i {ee,mm,em,et,mt,tt}/* -o workspace.root --parallel 4
</pre><p>Here we have specified the name of the output workspace explicitly with the <code>-o</code> option. The <b>T2W</b> mode also has a <code>--cc</code> option that can be used to specify the name of the combined text datacard that is created (default is <code>combined.txt</code>). When individual datacards are given as input, this option causes the cards to be combined first and produces a single workspace, as opposed to the default behaviour which would create a workspace per datacard. Run <code>combineTool.py -M T2W -h</code> for more information.</p>
<h2><a class="anchor" id="limits-calculating-limits"></a>
Calculating limits</h2>
<p>We now have a set of workspaces within a <code>{channel}/{mass}/workspace.root</code> directory structure. The next step is simply to run the <b>Asymptotic</b> mode of combine on each workspace, which again can be done with <code>combineTool.py</code>. The normal <code>-d/--datacard</code> option is enhanced to support multiple workspaces: </p>
<pre class="fragment">combineTool.py -M Asymptotic -d */*/workspace.root --there -n .limit --parallel 4
</pre><p>One minor complication is that <code>combine</code> produces its output in the directory we run it from. In this case the outputs for a mass point in the different channels will overwrite each other as there is nothing in the name option (<code>-n</code>) to distinguish them. The solution is to add the <code>--there</code> option which will run each <code>combine</code> command in the directory where the workspace is located.</p>
<h2><a class="anchor" id="limits-collecting"></a>
Collect the output</h2>
<p>Each output file contains a "limits" TTree with one entry for each of the observed and expected limits, for example: </p>
<pre class="fragment">*********************************************************************************
*    Row   *                   mh *     quantileExpected *                limit *
*********************************************************************************
*        0 *                  125 *                0.025 *              0.43943 *
*        1 *                  125 *                0.160 *              0.59707 *
*        2 *                  125 *                0.500 *              0.85547 *
*        3 *                  125 *                0.840 *                1.234 *
*        4 *                  125 *                0.975 *                 1.72 *
*        5 *                  125 *               -1.000 *               1.7361 *
*********************************************************************************
</pre><p>This could be used as a direct input for plotting but here we will use another <code>combineTool.py</code> method, <b>CollectLimits</b> to covert the information in these files to a more easily readable json file. This is a useful intermediate format for producing different figures and tables as it is simple to parse as a dictionary object in python.</p>
<p>We can use the directory structure to collect all the outputs in one go, creating one json file per channel: </p>
<pre class="fragment">combineTool.py -M CollectLimits */*/*.limit.* --use-dirs -o limits.json
</pre><p>By default the <b>CollectLimits</b> method will assume all the limit results should be merged into a single json file, but with the <code>--use-dirs</code> option it will group the output files according the parent directory name (skipping directories that correspond to mass values). The output files will have these directory names appended, e.g. <code>limits_mt.json</code>. The files are structured like a dictionary with one entry per mass value, e.g.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  <span class="stringliteral">&quot;110.0&quot;</span>: {</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    <span class="stringliteral">&quot;exp+1&quot;</span>: 1.4916164875030518,</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    <span class="stringliteral">&quot;exp+2&quot;</span>: 2.1045162677764893,</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    <span class="stringliteral">&quot;exp-1&quot;</span>: 0.7012145519256592,</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    <span class="stringliteral">&quot;exp-2&quot;</span>: 0.5117874145507812,</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    <span class="stringliteral">&quot;exp0&quot;</span>: 1.01171875,</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    <span class="stringliteral">&quot;obs&quot;</span>: 2.010412310353403</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;  },</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;  <span class="stringliteral">&quot;115.0&quot;</span>: {</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;    <span class="stringliteral">&quot;exp+1&quot;</span>: 1.3615484237670898,</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    <span class="stringliteral">&quot;exp+2&quot;</span>: 1.9097926616668701,</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    <span class="stringliteral">&quot;exp-1&quot;</span>: 0.6493316888809204,</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;    <span class="stringliteral">&quot;exp-2&quot;</span>: 0.47591400146484375,</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;    <span class="stringliteral">&quot;exp0&quot;</span>: 0.93359375,</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    <span class="stringliteral">&quot;obs&quot;</span>: 1.9418526167603543</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;  },</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;  ...</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd><b>CollectLimits</b> currently only supports the output the of the <b>Asymptotic</b> limit calculation. In future it will be extended to support extracting the results of toy-based signal injected limits as well as full CLs in the <b>HybridNew</b> method.</dd></dl>
<h2><a class="anchor" id="limits-plotting"></a>
Plotting</h2>
<p>The CombineHarvester <code>plotting</code> module provides a number of functions that can save time when creating limit plots. In particular, there are functions to convert a json file into a set of TGraphs containing the observed and expected limits as well as the 68 and 95% expected intervals. A minimal example is given below:</p>
<p>```py import ROOT from CombineHarvester.CombineTools.plotting import * ROOT.PyConfig.IgnoreCommandLineOptions = True ROOT.gROOT.SetBatch(ROOT.kTRUE)</p>
<h1>Style and pads</h1>
<p><a class="el" href="_plotting___style_8h.html#a7f6399c7470d5331ac4c464cb14c86e1" title="Sets an improved plotting style, using the CMS default as a base. ">ModTDRStyle()</a> canv = ROOT.TCanvas('limit', 'limit') pads = <a class="el" href="_plotting_8h.html#aa098641a0337d718d1074531133b884f" title="Just creates a single pad filling the entire canvas. ">OnePad()</a></p>
<h1>Get limit TGraphs as a dictionary</h1>
<p>graphs = StandardLimitsFromJSONFile('limits_mt.json')</p>
<h1>Create an empty TH1 from the first TGraph to serve as the pad axis and frame</h1>
<p>axis = CreateAxisHist(graphs.values()[0]) axis.GetXaxis().SetTitle('m_{H} (GeV)') axis.GetYaxis().SetTitle('95% CL limit on #mu') pads[0].cd() axis.Draw('axis')</p>
<h1>Create a legend in the top left</h1>
<p>legend = PositionedLegend(0.3, 0.2, 3, 0.015)</p>
<h1>Set the standard green and yellow colors and draw</h1>
<p>StyleLimitBand(graphs) DrawLimitBand(pads[0], graphs, legend=legend) legend.Draw()</p>
<h1>Re-draw the frame and tick marks</h1>
<p>pads[0].RedrawAxis() pads[0].GetFrame().Draw()</p>
<h1>Adjust the y-axis range such that the maximum graph value sits 25% below</h1>
<h1>the top of the frame. Fix the minimum to zero.</h1>
<p>FixBothRanges(pads[0], 0, 0, GetPadYMax(pads[0]), 0.25)</p>
<h1>Standard CMS logo</h1>
<p>DrawCMSLogo(pads[0], 'CMS', 'Internal', 11, 0.045, 0.035, 1.2, '', 0.8)</p>
<p>canv.Print('.pdf') canv.Print('.png') ```</p>
<p>This will produce a standard limit plot:</p>
<div class="image">
<img src="example_simple_limit.png" alt="example_simple_limit.png"/>
</div>
<p>A more fully-featured example can be found in <code>CombineTools/scripts/plotLimits.py</code>. This script support multiple json file arguments for drawing combined observed/expected bands as above, or specifying single limits to draw. For the former it is enough to just give the json file as the argument. It is possible to restrict the output to just the observed or expected limits with the <code>--show obs</code> or <code>--show exp</code> option. With the latter it's possible to overlay limits from different json files: </p>
<pre class="fragment">plotLimits.py limits_{ee,em,et,mm,mt,tt}.json:obs --auto-style
</pre><p>The limit to draw from each file is specified as <code>[file.json]:[limit]</code>. The <code>--auto-style</code> option will draw each TGraph with a different colour. Each TGraph can be styled further by extending the input argument: <code>[file.json]:[limit]:[style options]</code>. The last part is a comma-separated list of style settings that will be applied to the TGraph. All single-argument <code>SetXYZ(...)</code> methods are supported, e.g. <code>'limits_mt.json:exp:Title="#mu#tau_{h}",LineStyle=4</code> is equivalent to doing:</p>
<p>```cpp graph.SetTitle("#mu#tau_{h}") graph.SetLineStyle(4) ```</p>
<p>The following command will draw the observed and expected limits for three of the channels: </p>
<pre class="fragment">plotLimits.py --auto-style obs,exp \
  'limits_mt.json:obs:Title="#mu#tau_{h} Observed"'       \
  'limits_mt.json:exp0:Title="#mu#tau_{h} Expected"'      \
  'limits_et.json:obs:Title="e#tau_{h} Observed"'         \
  'limits_et.json:exp0:Title="e#tau_{h} Expected"'        \
  'limits_tt.json:obs:Title="#tau_{h}#tau_{h} Observed"'  \
  'limits_tt.json:exp0:Title="#tau_{h}#tau_{h} Expected"'
</pre><p>Note the use of single quotes to prevent bash removing the double quotes surrounding the graph titles. Here the <code>--auto-style</code> argument is given a list of groups for assigning style options. Graphs in each group are given a common line style and the same pool of colours are assigned in order for graphs within that group. The output of this command is given below.</p>
<div class="image">
<img src="example_plotLimits.png" alt="example_plotLimits.png"/>
</div>
<h2><a class="anchor" id="limits-morphing-cards"></a>
Workflow with RooMorphingPdf datacards</h2>
<p>For datacards using RooMorphingPdfs for the signal, the steps to produce limits are similar to the per-mass case above, with the main difference being the need to specify the set of mass values explicitly rather than picking this up from the directory structure. The <code>SMLegacyMorphing</code> program will create similar directory structure with the RooMorphingPdf version of the HIG-13-004 cards: </p>
<pre class="fragment">cd $CMSSW_BASE/src/CombineHarvester/CombineTools
SMLegacyMorphing
</pre><p>This program creates a directory per channel which already contain a combined datacard. We can specify these cards directly in the text2workspace step. </p>
<pre class="fragment">cd output/sm_cards_morphed/
combineTool.py -M T2W -i {ee,mm,em,et,mt,tt}/combinedCard.txt -o workspace.root --parallel 4
</pre><p>For the <b>Asymptotic</b> calculation we take advantage of the enhanced <code>-m</code> option to compute the limit in 2 GeV steps: </p>
<pre class="fragment">combineTool.py -M Asymptotic -d */workspace.root -m 110:144:2 --freezeNuisances MH --there -n .limit --parallel 4
</pre><p>After this, the output collection and the plotting is the same as above: </p>
<pre class="fragment">combineTool.py -M CollectLimits */*.limit.* --use-dirs -o limits.json
plotLimits.py limits_mt.json
</pre><div class="image">
<img src="example_plotLimitsMorphed.png" alt="example_plotLimitsMorphed.png"/>
</div>
<h1>Limit as a function of some other variable</h1>
<p><em>coming soon</em></p>
<h1><a class="anchor" id="limits-more-POIs"></a>
Limits in models with more than one POI</h1>
<h2><a class="anchor" id="limits-pre-vs-post"></a>
Expected limits: pre-fit vs post-fit</h2>
<p>With the <em>Asymptotic</em> method of combine it is only possible to determine a limit for a single POI at a time. This POI will be chosen as the first one in the list of POIs embedded within the workspace. Therefore it is best to always specify the POI list explicitly, putting the one you want the limit for first in the list, e.g. </p>
<pre class="fragment">combine -M Asymptotic -d workspace.root -m 125 --redefineSignalPOIs r_ggH,r_qqH
</pre><p>to set a limit on <code>r_ggH</code>. You should also decide how to treat the other POIs in the fits for the limit extraction. By default combine will allow all other POIs to float freely, so in this example <code>r_qqH</code> will be profiled. If instead you wish to fix it to a particular value then it should not be included in the list of POIs, e.g. </p>
<pre class="fragment">combine -M Asymptotic -d workspace.root -m 125 --redefineSignalPOIs r_ggH --setPhysicsModelParameters r_qqH=0.0 --freezeNuisances r_qqH
</pre><p>There is a further issue to consider when computing expected limits without a fit to the data (combine option <code>--run blind</code> or when generating toy datasets with <code>-t</code>). For the profiled case combine must generate a background-only pre-fit asimov dataset for use in the asymptotic calculation. In doing this only the first POI in the list will be fixed to zero. So if the other POI values are non-zero then the asimov dataset will contain a (probably) unwanted signal contribution. To avoid this it is safest to explicitly set the values of the other POIs to zero, e.g. </p>
<pre class="fragment">combine -M Asymptotic -d workspace.root -m 125 --redefineSignalPOIs r_ggH,r_qqH --setPhysicsModelParameters r_qqH=0.0
</pre><h2>Signal injected limits</h2>
<p><em>coming soon</em></p>
 </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
</body>
</html>
